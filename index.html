<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>產品數位護照 | Digital Product Passport</title>
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React 和 Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 自定義樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out forwards; }
        .animate-slideUp { animation: slideUp 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* 模擬程式碼區塊樣式 */
        .json-bg { background-color: #1e1e1e; color: #d4d4d4; }
        .json-key { color: #9cdcfe; }
        .json-string { color: #ce9178; }
        .json-number { color: #b5cea8; }
        
        /* 終端機風格日誌 */
        .terminal-log { background-color: #0f172a; color: #4ade80; font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 翻譯字典 ---
        const TRANSLATIONS = {
            zh: {
                title: "產品數位護照",
                subtitle: "請掃描產品上的 Digital Link QR Code 以查看產品履歷。",
                formatTitle: "Digital Link 網址格式",
                devLinks: "開發測試連結 (模擬掃描)",
                poweredBy: "Powered by",
                notFoundTitle: "查無此產品",
                notFoundDesc: "系統資料庫中找不到 GTIN 編號：",
                backHome: "返回首頁",
                verifiedPassport: "已驗證護照",
                tabTraceability: "旅程",
                tabMaterials: "材質",
                tabInfo: "資訊",
                footprintTitle: "產品足跡",
                footprintBadge: "全供應鏈追溯",
                materialComp: "材質組成",
                recyclingInst: "回收指示",
                specsTitle: "產品規格",
                gtinLabel: "GTIN (全球識別碼)",
                verifyBtn: "驗證區塊鏈證書 (Verifiable Credential)",
                verifyHint: "點擊上方按鈕以執行 W3C 標準 DID 驗證",
                vcTitle: "可驗證數位憑證",
                vcSubtitle: "Verifiable Credential (W3C Standard)",
                tabView: "憑證檢視",
                tabJson: "原始資料 (JSON-LD)",
                issuer: "發證者 (Issuer)",
                subject: "憑證持有者 (Subject)",
                date: "頒發日期",
                grsTitle: "GRS 認證摘要",
                grsStandard: "標準",
                grsRatio: "再生比例",
                grsCertNo: "證書編號",
                cprTitle: "歐盟 CPR 宣告",
                cprDop: "DoP 編號",
                cprFire: "防火等級",
                btnVerify: "驗證數位簽章",
                statusVerifying: "正在與去中心化網絡通訊中...",
                statusSuccess: "驗證成功",
                statusSuccessDesc: "此產品護照資料真實且未被篡改。",
                statusSuccessDetail: "DID 解析正確 • 簽章有效 • 證書未撤銷",
                logInit: "初始化 VC 驗證程序...",
                logResolve: "正在解析發證者 DID: ",
                logDidFetched: "DID 文件讀取成功",
                logKeyFound: "找到公開金鑰: key-1 (Ed25519)",
                logVerifySig: "正在驗證 JWS 數位簽章...",
                logSigValid: "簽章驗證通過。資料完整性確認。",
                logCheckRevoke: "檢查撤銷狀態清單 (StatusList2021)...",
                logActive: "憑證狀態：有效 (未撤銷)",
                logGrsCheck: "驗證 GRS 規範符合性...",
                logGrsValid: "Schema: GRS 4.0 已驗證",
                logComplete: "驗證流程結束。",
                specKeys: {
                    color: "顏色/外觀",
                    size: "尺寸/規格",
                    batch: "生產批號",
                    fireRating: "防火等級 (Euroclass)",
                    nrc: "吸音性能 (NRC)",
                    ceMark: "CE 認證標準"
                }
            },
            en: {
                title: "Digital Product Passport",
                subtitle: "Please scan the Digital Link QR Code on the product to view its passport.",
                formatTitle: "Digital Link URL Format",
                devLinks: "Dev Links (Simulate Scan)",
                poweredBy: "Powered by",
                notFoundTitle: "Product Not Found",
                notFoundDesc: "GTIN not found in the system database:",
                backHome: "Back to Home",
                verifiedPassport: "Verified Passport",
                tabTraceability: "Journey",
                tabMaterials: "Materials",
                tabInfo: "Info",
                footprintTitle: "Product Footprint",
                footprintBadge: "Full Traceability",
                materialComp: "Material Composition",
                recyclingInst: "Recycling Instructions",
                specsTitle: "Product Specifications",
                gtinLabel: "GTIN (Global Trade Item Number)",
                verifyBtn: "Verify Blockchain Credential",
                verifyHint: "Click above to perform W3C DID Verification",
                vcTitle: "Verifiable Credential",
                vcSubtitle: "W3C Standard",
                tabView: "Credential View",
                tabJson: "Raw Data (JSON-LD)",
                issuer: "Issuer",
                subject: "Subject",
                date: "Issuance Date",
                grsTitle: "GRS Summary",
                grsStandard: "Standard",
                grsRatio: "Recycled Content",
                grsCertNo: "Cert No.",
                cprTitle: "EU CPR Declaration",
                cprDop: "DoP Number",
                cprFire: "Fire Rating",
                btnVerify: "Verify Digital Signature",
                statusVerifying: "Communicating with decentralized network...",
                statusSuccess: "Verification Successful",
                statusSuccessDesc: "This passport data is authentic and tamper-proof.",
                statusSuccessDetail: "DID Resolved • Signature Valid • Not Revoked",
                logInit: "Initializing VC verification...",
                logResolve: "Resolving Issuer DID: ",
                logDidFetched: "DID Document fetched successfully",
                logKeyFound: "Public Key found: key-1 (Ed25519)",
                logVerifySig: "Verifying JWS Signature...",
                logSigValid: "Signature valid. Integrity check passed.",
                logCheckRevoke: "Checking Revocation Status (StatusList2021)...",
                logActive: "Credential is ACTIVE (Not Revoked)",
                logGrsCheck: "Validating GRS Schema Compliance...",
                logGrsValid: "Schema: GRS 4.0 Verified",
                logComplete: "Verification Process Complete.",
                specKeys: {
                    color: "Color",
                    size: "Size",
                    batch: "Batch No.",
                    fireRating: "Fire Rating",
                    nrc: "NRC",
                    ceMark: "CE Standard"
                }
            }
        };

        // --- Icon 組件 ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const QrCode = (p) => <IconBase {...p}><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></IconBase>;
        const Globe = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>;
        const Recycle = (p) => <IconBase {...p}><path d="M7 19H4.815a1.83 1.83 0 0 1-1.57-.881 1.785 1.785 0 0 1-.004-1.784L7.196 9.5"/><path d="M11 19h8.203a1.83 1.83 0 0 0 1.556-.89 1.784 1.784 0 0 0 0-1.775l-1.226-2.12"/><path d="m14 16-3 3 3 3"/><path d="M8.293 13.596 7.196 9.5 3.1 7"/><path d="m4.8 19 3 3 3-3"/><path d="M8.5 7.5c.34-1.12.91-2.17 1.63-3.1.66-.85 1.54-1.4 2.51-1.4 2.2 0 4.18 1.48 4.97 3.5"/><path d="M15.5 4.5l3 3-3 3"/></IconBase>;
        const Info = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const CheckCircle = (p) => <IconBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const Package = (p) => <IconBase {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconBase>;
        const ArrowRight = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const ShieldCheck = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const FileJson = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M10 13a2 2 0 0 0 2 2h4"/><path d="M12 15v3"/></IconBase>;
        const Lock = (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const Loader = (p) => <IconBase {...p} className={`${p.className} animate-spin`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;
        const Building = (p) => <IconBase {...p}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></IconBase>;
        const Languages = (p) => <IconBase {...p}><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></IconBase>;


        // --- 產品資料庫 (支援雙語結構) ---
        const PRODUCT_DATABASE = {
            "09876543210999": {
                name: { zh: "EcoSound 再生吸音板", en: "EcoSound Recycled Acoustic Panel" },
                brand: { zh: "BuildGreen EU", en: "BuildGreen EU" },
                image: "https://images.unsplash.com/photo-1629196911514-cfd8d63f6635?auto=format&fit=crop&w=600&q=80",
                description: {
                    zh: "高性能聲學吸音板，由 100% GRS 認證的再生 PET 纖維製成，符合歐盟建築法規 (CPR)。",
                    en: "High-performance acoustic panel made from 100% GRS certified recycled PET fibers, compliant with EU CPR."
                },
                specs: { 
                    color: { zh: "石墨灰", en: "Graphite Grey" },
                    size: { zh: "1200x600x50mm", en: "1200x600x50mm" },
                    batch: { zh: "EU-2024-C99", en: "EU-2024-C99" },
                    fireRating: { zh: "Euroclass B-s1, d0", en: "Euroclass B-s1, d0" },
                    nrc: { zh: "0.85 (吸音係數)", en: "0.85 (NRC)" },
                    ceMark: { zh: "Yes (EN 15102)", en: "Yes (EN 15102)" }
                },
                traceability: [
                    { step: { zh: "PET 瓶磚回收", en: "PET Bottle Bale Recycling" }, location: { zh: "德國, 柏林", en: "Berlin, Germany" }, date: "2023-11-05", icon: Recycle },
                    { step: { zh: "纖維抽絲加工", en: "Fiber Extrusion" }, location: { zh: "波蘭, 羅茲", en: "Lodz, Poland" }, date: "2023-11-20", icon: Package },
                    { step: { zh: "熱壓成型與裁切", en: "Thermoforming & Cutting" }, location: { zh: "捷克, 布拉格", en: "Prague, Czechia" }, date: "2023-12-01", icon: Building },
                ],
                materials: [
                    { name: { zh: "rPET (再生聚酯纖維)", en: "rPET (Recycled Polyester)" }, percentage: 100 },
                ],
                disposal: { zh: "可透過原廠回收計畫進行 100% 閉環回收。", en: "100% closed-loop recyclable via manufacturer take-back program." },
                verifiableCredential: {
                    "@context": ["https://www.w3.org/2018/credentials/v1", "https://schema.org/"],
                    "type": ["VerifiableCredential", "GRSCertificate", "ConstructionProductDeclaration"],
                    "issuer": "did:web:cert.controlunion.com",
                    "issuanceDate": "2024-01-15T09:00:00Z",
                    "credentialSubject": {
                        "id": "did:web:dpp-demo.sdpp.tw:product:09876543210999",
                        "gtin": "09876543210999",
                        "grsCertification": {
                            "standard": "Global Recycled Standard (GRS) 4.0",
                            "scope": "Post-consumer Recycled Content",
                            "percentage": "100%",
                            "certificateNo": "CU-899123-2024"
                        },
                        "constructionDeclaration": {
                            "regulation": "EU Construction Products Regulation (CPR)",
                            "dopNumber": "DoP-2024-001",
                            "harmonizedStandard": "EN 15102:2007+A1:2011",
                            "fireClassification": "B-s1, d0"
                        }
                    },
                    "proof": { "type": "JsonWebSignature2020", "jws": "eyJhbGciOiJFZERTQSIsIm..." }
                }
            },
            "09876543210123": {
                name: { zh: "EcoStep Pro 跑鞋", en: "EcoStep Pro Running Shoes" },
                brand: { zh: "GreenWalk", en: "GreenWalk" },
                image: "https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=600&q=80",
                description: { zh: "由 100% 海洋回收塑料製成的高性能跑鞋。", en: "High-performance running shoes made from 100% ocean recycled plastics." },
                specs: { 
                    color: { zh: "海洋藍", en: "Ocean Blue" }, 
                    size: { zh: "US 10", en: "US 10" }, 
                    batch: { zh: "2024-Q1-TW", en: "2024-Q1-TW" } 
                },
                traceability: [
                    { step: { zh: "原料採集", en: "Material Collection" }, location: { zh: "台灣, 澎湖", en: "Penghu, Taiwan" }, date: "2023-10-01", icon: Recycle },
                    { step: { zh: "紡織加工", en: "Textile Processing" }, location: { zh: "台灣, 彰化", en: "Changhua, Taiwan" }, date: "2023-11-15", icon: Package },
                    { step: { zh: "最終組裝", en: "Final Assembly" }, location: { zh: "越南, 胡志明", en: "Ho Chi Minh City, Vietnam" }, date: "2024-01-20", icon: CheckCircle },
                ],
                materials: [
                    { name: { zh: "回收 PET", en: "Recycled PET" }, percentage: 80 }, 
                    { name: { zh: "天然橡膠", en: "Natural Rubber" }, percentage: 20 }
                ],
                disposal: { zh: "可透過品牌門市回收計畫進行回收。", en: "Recyclable through brand store take-back programs." },
                verifiableCredential: {
                    "@context": ["https://www.w3.org/2018/credentials/v1"],
                    "type": ["VerifiableCredential", "SustainableProductClaim"],
                    "issuer": "did:web:issuer.greenwalk.com",
                    "issuanceDate": "2023-11-20T19:23:24Z",
                    "credentialSubject": {
                        "id": "did:web:dpp-demo.sdpp.tw:product:09876543210123",
                        "gtin": "09876543210123",
                        "claim": { "recycledContent": "80%", "carbonNeutral": true }
                    },
                    "proof": { "type": "JsonWebSignature2020", "jws": "eyJhbGciOiJFZERTQSIsImI2..." }
                }
            },
            "09876543210456": {
                name: { zh: "PureCotton 經典 T-shirt", en: "PureCotton Classic T-shirt" },
                brand: { zh: "GreenWalk", en: "GreenWalk" },
                image: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?auto=format&fit=crop&w=600&q=80",
                description: { zh: "無毒、無農藥的有機棉，對肌膚最溫柔的呵護。", en: "Toxic-free, pesticide-free organic cotton, gentle on your skin." },
                specs: { 
                    color: { zh: "米白", en: "Off-White" }, 
                    size: { zh: "L", en: "L" }, 
                    batch: { zh: "2024-JAN-Batch", en: "2024-JAN-Batch" } 
                },
                traceability: [
                    { step: { zh: "棉花種植", en: "Cotton Farming" }, location: { zh: "土耳其, 伊茲密爾", en: "Izmir, Turkey" }, date: "2023-08-01", icon: MapPin },
                    { step: { zh: "紡紗織布", en: "Spinning & Weaving" }, location: { zh: "葡萄牙, 波爾圖", en: "Porto, Portugal" }, date: "2023-09-20", icon: Package },
                    { step: { zh: "品檢包裝", en: "QC & Packaging" }, location: { zh: "德國, 漢堡", en: "Hamburg, Germany" }, date: "2023-10-10", icon: CheckCircle },
                ],
                materials: [
                    { name: { zh: "有機棉", en: "Organic Cotton" }, percentage: 100 }
                ],
                disposal: { zh: "可自然生物降解，或投入衣物回收箱。", en: "Biodegradable or suitable for clothing recycling bins." },
                verifiableCredential: {
                    "@context": ["https://www.w3.org/2018/credentials/v1"],
                    "type": ["VerifiableCredential", "OrganicCottonCert"],
                    "issuer": "did:web:cert.global-organic.org",
                    "issuanceDate": "2023-09-15T10:00:00Z",
                    "credentialSubject": {
                        "id": "did:web:dpp-demo.sdpp.tw:product:09876543210456",
                        "gtin": "09876543210456",
                        "certificationLevel": "GOTS Certified"
                    }
                }
            }
        };

        // --- 組件: 語言切換器 ---
        const LanguageSwitcher = ({ lang, setLang }) => (
            <button 
                onClick={() => setLang(lang === 'zh' ? 'en' : 'zh')}
                className="fixed top-4 right-4 z-50 bg-white/90 backdrop-blur border border-gray-200 shadow-sm px-3 py-1.5 rounded-full flex items-center gap-2 text-xs font-bold hover:bg-gray-50 transition"
            >
                <Languages className="w-3.5 h-3.5" />
                <span className={lang === 'zh' ? 'text-green-600' : 'text-gray-400'}>中文</span>
                <span className="text-gray-300">|</span>
                <span className={lang === 'en' ? 'text-green-600' : 'text-gray-400'}>EN</span>
            </button>
        );

        // --- 組件: Verifiable Credential Modal ---
        const CredentialModal = ({ isOpen, onClose, data, lang }) => {
            const [viewMode, setViewMode] = useState('visual'); 
            const [verificationState, setVerificationState] = useState('idle'); 
            const [logs, setLogs] = useState([]);
            const logEndRef = useRef(null);
            const t = TRANSLATIONS[lang];

            useEffect(() => {
                if (isOpen) {
                    setVerificationState('idle');
                    setLogs([]);
                }
            }, [isOpen]);

            useEffect(() => {
                logEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [logs]);

            const runVerification = () => {
                setVerificationState('verifying');
                setLogs([]);
                
                const addLog = (text, type = 'info') => {
                    setLogs(prev => [...prev, { text, type, time: new Date().toLocaleTimeString() }]);
                };

                addLog(t.logInit, 'info');
                
                setTimeout(() => {
                    addLog(`${t.logResolve} ${data.issuer}`, 'cmd');
                }, 800);

                setTimeout(() => {
                    addLog(`  ✔ ${t.logDidFetched}`, 'success');
                    addLog(`  ✔ ${t.logKeyFound}`, 'success');
                }, 1800);

                setTimeout(() => {
                    addLog(`> ${t.logVerifySig}`, 'cmd');
                    addLog(`  Payload digest: sha256:${data.credentialSubject.gtin.substring(0,8)}...`, 'detail');
                }, 2800);

                setTimeout(() => {
                    addLog(`  ✔ ${t.logSigValid}`, 'success');
                }, 3800);

                setTimeout(() => {
                    addLog(`> ${t.logCheckRevoke}`, 'cmd');
                    addLog(`  Registry: ethereum:mainnet:0x123...abc`, 'detail');
                }, 4800);

                setTimeout(() => {
                    addLog(`  ✔ ${t.logActive}`, 'success');
                    if (data.credentialSubject.grsCertification) {
                        addLog(`> ${t.logGrsCheck}`, 'cmd');
                        addLog(`  ✔ ${t.logGrsValid}`, 'success');
                    }
                    setVerificationState('verified');
                    addLog(t.logComplete, 'done');
                }, 5800);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl relative z-10 overflow-hidden flex flex-col max-h-[90vh] animate-slideUp">
                        {/* Header */}
                        <div className="bg-slate-900 text-white p-5 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <ShieldCheck className="w-6 h-6 text-green-400" />
                                <div>
                                    <h3 className="font-bold text-lg">{t.vcTitle}</h3>
                                    <p className="text-xs text-slate-400">{t.vcSubtitle}</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="p-1 hover:bg-slate-800 rounded-full transition"><X className="w-6 h-6" /></button>
                        </div>

                        {/* Content */}
                        <div className="p-6 overflow-y-auto flex-1">
                            {/* Tabs */}
                            <div className="flex gap-2 mb-6 bg-slate-100 p-1 rounded-lg">
                                <button 
                                    onClick={() => setViewMode('visual')}
                                    className={`flex-1 py-2 text-sm font-medium rounded-md transition flex items-center justify-center gap-2 ${viewMode === 'visual' ? 'bg-white shadow text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <ShieldCheck className="w-4 h-4" /> {t.tabView}
                                </button>
                                <button 
                                    onClick={() => setViewMode('json')}
                                    className={`flex-1 py-2 text-sm font-medium rounded-md transition flex items-center justify-center gap-2 ${viewMode === 'json' ? 'bg-white shadow text-slate-900' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <FileJson className="w-4 h-4" /> {t.tabJson}
                                </button>
                            </div>

                            {viewMode === 'visual' ? (
                                <div className="space-y-6">
                                    {/* 憑證卡片 */}
                                    <div className="border border-slate-200 rounded-xl p-5 bg-slate-50 relative overflow-hidden transition-all duration-300">
                                        {verificationState === 'verified' && (
                                            <div className="absolute top-0 right-0 p-2 animate-fadeIn">
                                                <div className="bg-green-100 text-green-700 text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1 border border-green-200 shadow-sm">
                                                    <CheckCircle className="w-3 h-3" /> Verified
                                                </div>
                                            </div>
                                        )}
                                        
                                        <div className="space-y-4">
                                            <div>
                                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">{t.issuer}</p>
                                                <div className="flex items-center gap-2">
                                                    <div className="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-xs">DID</div>
                                                    <p className="text-sm font-mono text-slate-700 truncate">{data.issuer}</p>
                                                </div>
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">{t.subject}</p>
                                                <p className="text-sm font-mono text-slate-700 truncate">{data.credentialSubject.id}</p>
                                            </div>
                                            <div>
                                                <p className="text-xs text-slate-500 uppercase font-bold tracking-wider mb-1">{t.date}</p>
                                                <p className="text-sm text-slate-700">{new Date(data.issuanceDate).toLocaleDateString()} {new Date(data.issuanceDate).toLocaleTimeString()}</p>
                                            </div>

                                            {/* GRS 特殊顯示區塊 */}
                                            {data.credentialSubject.grsCertification && (
                                                <div className="mt-4 pt-4 border-t border-slate-100">
                                                    <p className="text-xs text-green-600 uppercase font-bold tracking-wider mb-2 flex items-center gap-1">
                                                        <Recycle className="w-3 h-3" /> {t.grsTitle}
                                                    </p>
                                                    <div className="bg-green-50 rounded-lg p-3 text-sm space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-600">{t.grsStandard}:</span>
                                                            <span className="font-semibold text-slate-800">{data.credentialSubject.grsCertification.standard}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-600">{t.grsRatio}:</span>
                                                            <span className="font-bold text-green-700">{data.credentialSubject.grsCertification.percentage}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-600">{t.grsCertNo}:</span>
                                                            <span className="font-mono text-slate-800">{data.credentialSubject.grsCertification.certificateNo}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {/* CPR 特殊顯示區塊 */}
                                            {data.credentialSubject.constructionDeclaration && (
                                                <div className="mt-2">
                                                    <p className="text-xs text-blue-600 uppercase font-bold tracking-wider mb-2 flex items-center gap-1">
                                                        <Building className="w-3 h-3" /> {t.cprTitle}
                                                    </p>
                                                    <div className="bg-blue-50 rounded-lg p-3 text-sm space-y-2">
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-600">{t.cprDop}:</span>
                                                            <span className="font-mono text-slate-800">{data.credentialSubject.constructionDeclaration.dopNumber}</span>
                                                        </div>
                                                        <div className="flex justify-between">
                                                            <span className="text-slate-600">{t.cprFire}:</span>
                                                            <span className="font-bold text-blue-800">{data.credentialSubject.constructionDeclaration.fireClassification}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* 驗證區塊 */}
                                    <div className="border-t border-slate-100 pt-6">
                                        {verificationState === 'idle' ? (
                                            <button 
                                                onClick={runVerification}
                                                className="w-full py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-bold flex items-center justify-center gap-2 transition shadow-lg shadow-slate-200"
                                            >
                                                <Lock className="w-4 h-4" /> {t.btnVerify}
                                            </button>
                                        ) : (
                                            <div className="space-y-3">
                                                <div className="terminal-log p-4 rounded-lg text-xs font-mono h-40 overflow-y-auto shadow-inner border border-slate-700">
                                                    {logs.map((log, idx) => (
                                                        <div key={idx} className={`mb-1 ${
                                                            log.type === 'cmd' ? 'text-yellow-400 font-bold' : 
                                                            log.type === 'success' ? 'text-green-400' : 
                                                            log.type === 'detail' ? 'text-slate-500 pl-4' : 
                                                            log.type === 'done' ? 'text-cyan-400 font-bold border-t border-slate-700 mt-2 pt-2' : 'text-slate-300'
                                                        }`}>
                                                            <span className="opacity-50 mr-2">[{log.time}]</span>
                                                            {log.text}
                                                        </div>
                                                    ))}
                                                    <div ref={logEndRef} />
                                                </div>
                                                
                                                {verificationState === 'verifying' && (
                                                    <div className="flex items-center gap-3 animate-fadeIn justify-center pt-2">
                                                        <Loader className="w-5 h-5 text-slate-400" />
                                                        <span className="text-sm text-slate-500">{t.statusVerifying}</span>
                                                    </div>
                                                )}
                                                
                                                {verificationState === 'verified' && (
                                                    <div className="mt-4 p-3 bg-green-50 rounded-xl border border-green-100 text-center animate-fadeIn">
                                                        <p className="text-green-800 font-bold text-base mb-1">{t.statusSuccess}</p>
                                                        <p className="text-green-600 text-xs">{t.statusSuccessDesc}</p>
                                                        <p className="text-green-600 text-[10px] mt-1 opacity-80">{t.statusSuccessDetail}</p>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ) : (
                                // JSON 檢視模式
                                <div className="json-bg p-4 rounded-xl overflow-x-auto text-xs font-mono h-80 shadow-inner">
                                    <pre>{JSON.stringify(data, null, 2)}</pre>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 組件: 首頁 ---
        const LandingPage = ({ onScan, lang, setLang }) => {
            const t = TRANSLATIONS[lang];
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-6 text-center relative">
                    <LanguageSwitcher lang={lang} setLang={setLang} />
                    
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full animate-fadeIn">
                        <div className="flex justify-center mb-6">
                            <div className="bg-green-100 p-4 rounded-full">
                                <QrCode className="w-12 h-12 text-green-600" />
                            </div>
                        </div>
                        <h1 className="text-2xl font-bold text-gray-800 mb-2">{t.title}</h1>
                        <p className="text-gray-500 mb-4 text-sm">
                            {t.subtitle}
                        </p>

                        <div className="bg-slate-50 border border-slate-200 rounded p-3 mb-8 text-left">
                            <p className="text-[10px] text-gray-400 uppercase font-bold tracking-wider mb-1">{t.formatTitle}</p>
                            <p className="text-xs font-mono text-gray-600 break-all select-all">
                            https://dpp-demo.sdpp.tw/#/01/<span className="text-green-600">{'{GTIN}'}</span>
                            </p>
                        </div>
                        
                        <div className="border-t border-gray-100 pt-6">
                            <p className="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">{t.devLinks}</p>
                            <div className="space-y-3">
                                {Object.entries(PRODUCT_DATABASE).map(([gtin, prod]) => (
                                    <button 
                                        key={gtin}
                                        onClick={() => onScan(gtin)}
                                        className="w-full py-3 px-4 bg-white border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-200 hover:text-green-700 transition flex items-center justify-between group"
                                    >
                                        <div className="text-left">
                                            <span className="block font-medium text-sm text-gray-800 group-hover:text-green-800">{prod.name[lang]}</span>
                                            <span className="block text-xs text-gray-400 font-mono">GTIN: {gtin}</span>
                                        </div>
                                        <ArrowRight className="w-4 h-4 text-gray-300 group-hover:text-green-500" />
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="mt-8 text-xs text-gray-400 flex items-center justify-center gap-1">
                        {t.poweredBy} <span className="font-semibold text-gray-500">dpp-demo.sdpp.tw</span>
                    </div>
                </div>
            );
        };

        // --- 組件: 產品詳情頁 ---
        const PassportPage = ({ product, gtin, onBack, lang, setLang }) => {
            const [activeTab, setActiveTab] = useState('traceability');
            const [isCredentialOpen, setIsCredentialOpen] = useState(false);
            const t = TRANSLATIONS[lang];

            if (!product) return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-6 relative">
                    <LanguageSwitcher lang={lang} setLang={setLang} />
                    <div className="bg-white p-8 rounded-xl shadow-lg text-center max-w-sm w-full animate-fadeIn">
                        <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <X className="w-8 h-8 text-red-500" />
                        </div>
                        <h2 className="text-xl font-bold text-gray-800">{t.notFoundTitle}</h2>
                        <p className="text-gray-600 mt-2 text-sm">{t.notFoundDesc}<br/><span className="font-mono bg-gray-100 px-2 py-1 rounded mt-1 inline-block">{gtin}</span></p>
                        <button onClick={onBack} className="mt-6 w-full py-2.5 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition font-medium">{t.backHome}</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 pb-12 animate-fadeIn relative">
                    <LanguageSwitcher lang={lang} setLang={setLang} />
                    
                    <CredentialModal 
                        isOpen={isCredentialOpen} 
                        onClose={() => setIsCredentialOpen(false)} 
                        data={product.verifiableCredential}
                        lang={lang}
                    />

                    <div className="relative h-72 w-full bg-gray-900">
                        <img src={product.image} alt={product.name[lang]} className="w-full h-full object-cover opacity-90" />
                        <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent" />
                        <button onClick={onBack} className="absolute top-4 left-4 bg-black/30 backdrop-blur-md text-white p-2 rounded-full hover:bg-black/50 transition border border-white/10 z-40">
                            <ArrowRight className="w-5 h-5 rotate-180" />
                        </button>
                        <div className="absolute bottom-0 left-0 right-0 p-6">
                            <div className="flex items-center gap-2 mb-2">
                                <span className="px-2 py-0.5 bg-green-500/90 text-white text-[10px] font-bold tracking-wider rounded uppercase backdrop-blur-sm flex items-center gap-1">
                                    <ShieldCheck className="w-3 h-3" /> {t.verifiedPassport}
                                </span>
                            </div>
                            <h1 className="text-2xl font-bold text-white leading-tight mb-1">{product.name[lang]}</h1>
                            <p className="text-white/80 text-sm font-medium">{product.brand[lang]}</p>
                        </div>
                    </div>

                    <div className="px-4 -mt-4 relative z-10">
                        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden min-h-[50vh]">
                            <div className="flex border-b border-gray-100">
                                {['traceability', 'materials', 'info'].map(tab => (
                                    <button 
                                        key={tab}
                                        onClick={() => setActiveTab(tab)}
                                        className={`flex-1 py-4 text-sm font-medium flex items-center justify-center gap-1.5 transition-colors relative
                                        ${activeTab === tab ? 'text-green-700' : 'text-gray-400 hover:text-gray-600'}`}
                                    >
                                        {tab === 'traceability' && <Globe className="w-4 h-4" />}
                                        {tab === 'materials' && <Recycle className="w-4 h-4" />}
                                        {tab === 'info' && <Info className="w-4 h-4" />}
                                        <span className="capitalize">
                                            {tab === 'traceability' ? t.tabTraceability : tab === 'materials' ? t.tabMaterials : t.tabInfo}
                                        </span>
                                        {activeTab === tab && <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-green-600 rounded-t-full mx-4" />}
                                    </button>
                                ))}
                            </div>

                            <div className="p-6">
                                {activeTab === 'traceability' && (
                                    <div className="animate-fadeIn">
                                        <div className="flex items-center justify-between mb-6">
                                            <h3 className="font-bold text-gray-800 text-lg">{t.footprintTitle}</h3>
                                            <span className="text-xs bg-green-50 text-green-700 px-2 py-1 rounded-full font-medium">{t.footprintBadge}</span>
                                        </div>
                                        <div className="relative border-l-2 border-gray-100 pl-8 space-y-8 ml-2">
                                            {product.traceability.map((step, idx) => (
                                                <div key={idx} className="relative group">
                                                    <div className="absolute -left-[39px] bg-white p-1 rounded-full border border-gray-200 group-hover:border-green-500 transition-colors z-10">
                                                        <div className="bg-green-50 p-1.5 rounded-full">
                                                            <step.icon className="w-4 h-4 text-green-600" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <span className="text-xs font-bold text-green-600 uppercase tracking-wide mb-1 block">{step.step[lang]}</span>
                                                        <p className="text-gray-900 font-bold text-base">{step.location[lang]}</p>
                                                        <p className="text-sm text-gray-400 mt-1 font-mono">{step.date}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'materials' && (
                                    <div className="space-y-8 animate-fadeIn">
                                        <div>
                                            <h3 className="font-bold text-gray-800 text-lg mb-4">{t.materialComp}</h3>
                                            <div className="space-y-5">
                                                {product.materials.map((mat, idx) => (
                                                    <div key={idx}>
                                                        <div className="flex justify-between text-sm mb-2">
                                                            <span className="font-medium text-gray-700">{mat.name[lang]}</span>
                                                            <span className="font-bold text-gray-900">{mat.percentage}%</span>
                                                        </div>
                                                        <div className="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                                                            <div className="bg-gradient-to-r from-green-500 to-emerald-400 h-full rounded-full transition-all duration-1000 ease-out" style={{ width: `${mat.percentage}%` }}></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-xl border border-blue-100">
                                            <h4 className="text-sm font-bold text-blue-900 mb-2 flex items-center gap-2">
                                                <Recycle className="w-4 h-4" /> {t.recyclingInst}
                                            </h4>
                                            <p className="text-sm text-blue-800/80 leading-relaxed">{product.disposal[lang]}</p>
                                        </div>
                                    </div>
                                )}
                                {activeTab === 'info' && (
                                    <div className="space-y-6 animate-fadeIn">
                                        <h3 className="font-bold text-gray-800 text-lg">{t.specsTitle}</h3>
                                        <div className="grid grid-cols-2 gap-3">
                                            {/* 動態渲染規格 */}
                                            {Object.entries(product.specs).map(([key, value]) => (
                                                <div key={key} className={`p-4 bg-gray-50 rounded-xl border border-gray-100 ${key === 'batch' || key === 'ceMark' ? 'col-span-2' : ''}`}>
                                                    <span className="text-xs text-gray-400 block mb-1 capitalize">
                                                        {t.specKeys[key] || key}
                                                    </span>
                                                    <span className="text-sm font-semibold text-gray-800">{value[lang]}</span>
                                                </div>
                                            ))}
                                            
                                            <div className="p-4 bg-gray-50 rounded-xl border border-gray-100 col-span-2">
                                                <span className="text-xs text-gray-400 block mb-1">{t.gtinLabel}</span>
                                                <span className="text-sm font-semibold text-gray-800 font-mono tracking-wide">{gtin}</span>
                                            </div>
                                        </div>
                                        
                                        {/* 觸發 VC Modal 的按鈕區塊 */}
                                        <div className="pt-4 border-t border-gray-100">
                                            <button 
                                                onClick={() => setIsCredentialOpen(true)}
                                                className="w-full flex items-center justify-center gap-2 text-sm text-green-600 font-bold bg-green-50 py-3 rounded-lg hover:bg-green-100 transition"
                                            >
                                                <ShieldCheck className="w-4 h-4" />
                                                {t.verifyBtn}
                                            </button>
                                            <p className="text-xs text-center text-gray-400 mt-2">
                                                {t.verifyHint}
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 主程式 ---
        const App = () => {
            const [currentGtin, setCurrentGtin] = useState(null);
            const [lang, setLang] = useState('zh'); // 預設語言: 中文

            const getGtinFromHash = () => {
                const hash = window.location.hash; 
                if (!hash) return null;
                const parts = hash.split('/');
                const identifierIndex = parts.indexOf('01');
                if (identifierIndex !== -1 && parts[identifierIndex + 1]) {
                    return parts[identifierIndex + 1];
                }
                return null;
            };

            useEffect(() => {
                setCurrentGtin(getGtinFromHash());
                const handleHashChange = () => setCurrentGtin(getGtinFromHash());
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            const navigateToProduct = (gtin) => {
                window.location.hash = `/01/${gtin}`;
            };

            const navigateHome = () => {
                window.location.hash = '';
            };

            if (currentGtin) {
                const product = PRODUCT_DATABASE[currentGtin];
                return <PassportPage product={product} gtin={currentGtin} onBack={navigateHome} lang={lang} setLang={setLang} />;
            }
            return <LandingPage onScan={navigateToProduct} lang={lang} setLang={setLang} />;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
